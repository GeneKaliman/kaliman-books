<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Мобильный ридер — История климата</title>
  <style>
    :root {
      --bg: #0b0b0c;
      --fg: #e7e7ea;
      --muted: #9aa0a6;
      --accent: #8ab4f8;
      --bar: rgba(0,0,0,0.7);
      --bar-blur: blur(6px);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      overscroll-behavior: none;
    }

    /* Chrome (top/bottom overlays) */
    .topbar, .bottombar {
      position: fixed; left: 0; right: 0; z-index: 10;
      display: flex; align-items: center; gap: 12px;
      padding: env(safe-area-inset-top) 12px 12px 12px;
      backdrop-filter: var(--bar-blur);
      background: var(--bar);
      transform: translateY(-100%);
      transition: transform .25s ease;
    }
    .bottombar {
      bottom: 0; top: auto; padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      transform: translateY(100%);
      justify-content: space-between;
    }
    body.chrome-visible .topbar { transform: translateY(0); }
    body.chrome-visible .bottombar { transform: translateY(0); }

    .btn {
      appearance: none; border: 0; border-radius: 12px; padding: 8px 12px;
      background: rgba(255,255,255,0.06); color: var(--fg); font-size: 16px;
    }
    .btn:active { background: rgba(255,255,255,0.1); }
    .icon { font-size: 20px; line-height: 1; }

    /* Canvas wrap */
    .scroller { width: 100%; height: 100%; overflow-y: hidden; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
    body.scrollY .scroller { overflow-y: auto; }
    .stage {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      touch-action: manipulation; /* we'll manage pinch separately */
    }
    canvas {
      display: block;
      background: #fff;
      max-width: 100%;
      height: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    /* Tap zones */
    .tapzone {
      position: fixed; top: 0; bottom: 0; width: 33.34%; z-index: 5;
    }
    .tap-left  { left: 0; }
    .tap-mid   { left: 33.34%; }
    .tap-right { right: 0; }

    /* Progress */
    .progress {
      position: absolute; left: 0; bottom: 0;
      height: 3px; width: 100%; background: rgba(255,255,255,0.08);
    }
    .progress > span {
      display: block; height: 100%; width: 0;
      background: var(--accent); transition: width .2s ease;
    }

    /* Drawer (TOC) */
    .drawer {
      position: fixed; top: 0; bottom: 0; right: 0; width: min(88vw, 380px); z-index: 20;
      background: #121316; border-left: 1px solid #202124; transform: translateX(100%);
      transition: transform .25s ease;
      display: flex; flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    .drawer header { padding: 16px; border-bottom: 1px solid #202124; font-weight: 600; }
    .drawer .toc {
      flex: 1; overflow: auto; padding: 6px 8px 16px 8px;
    }
    .toc button {
      width: 100%; text-align: left; padding: 10px 12px; margin: 6px 4px;
      background: transparent; color: var(--fg); border: 1px solid #202124; border-radius: 10px;
      font-size: 15px;
    }
    .toc button:active { background: rgba(255,255,255,0.06); }

    /* Hidden input slider style */
    .zoom-pack { display: flex; align-items: center; gap: 8px; }
    input[type="range"] { width: 160px; }

    /* Small helpers */
    .meta { font-size: 13px; color: var(--muted); }
    .spacer { flex: 1; }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="menuBtn" class="btn"><span class="icon">☰</span> Меню</button>
    <div class="meta" id="pageMeta">Стр. — / —</div>
    <div class="spacer"></div>
    <button id="aaBtn" class="btn">Aa</button>
  </div>

  <div class="bottombar">
    <div class="zoom-pack">
      <button id="zoomOut" class="btn">−</button>
      <input id="zoomSlider" type="range" min="70" max="220" value="100" step="5">
      <button id="zoomIn" class="btn">+</button>
    </div>
    <button id="fitBtn" class="btn">Подогнать ширину</button>
  </div>

  <div class="stage">
    <div class="scroller" id="scroller">
    <canvas id="page"></canvas>
    </div>
    <div class="progress"><span id="progressBar"></span></div>
  </div>

  <!-- Tap zones for navigation & chrome toggle -->
  <div class="tapzone tap-left"  id="zonePrev"></div>
  <div class="tapzone tap-mid"   id="zoneToggle"></div>
  <div class="tapzone tap-right" id="zoneNext"></div>

  <!-- TOC Drawer -->
  <aside class="drawer" id="drawer">
    <header>
      Содержание
      <div class="meta">Коснитесь главы для перехода</div>
    </header>
    <div class="toc" id="tocList"></div>
  </aside>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';

    const PDF_URL = 'History_Climate.pdf'; // тот же источник
    const canvas = document.getElementById('page');
    const scroller = document.getElementById('scroller');

    function isLandscape(){ return (window.matchMedia && window.matchMedia('(orientation: landscape)').matches) || (window.innerWidth>window.innerHeight); }
    function setScrollMode(on) {
      document.body.classList.toggle('scrollY', !!on);
      if (!on) scroller.scrollTop = 0;
    }

    function shouldScroll() {
      // Enable scroll if the rendered page is taller than the viewport (common in landscape fit-by-width)
      const stageH = document.documentElement.clientHeight;
      const canvasH = parseFloat(canvas.style.height) || canvas.height;
      return canvasH > stageH + 1; // +1 for rounding
    }

    const ctx = canvas.getContext('2d');
    const menuBtn = document.getElementById('menuBtn');
    const aaBtn = document.getElementById('aaBtn');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const zoomSlider = document.getElementById('zoomSlider');
    const fitBtn = document.getElementById('fitBtn');
    const pageMeta = document.getElementById('pageMeta');
    const progressBar = document.getElementById('progressBar');
    const drawer = document.getElementById('drawer');
    const tocList = document.getElementById('tocList');
    const zonePrev = document.getElementById('zonePrev');
    const zoneNext = document.getElementById('zoneNext');
    const zoneToggle = document.getElementById('zoneToggle');

    let pdfDoc = null, pageNum = 1, totalPages = 0;
    let scale = parseFloat(localStorage.getItem('mScale') || '1.0');
    let fitWidth = JSON.parse(localStorage.getItem('mFitWidth') || 'true'); // по умолчанию как Kindle — подгоняем ширину
    let showChrome = false;

    const tocEntries = [
      { title: 'Введение', page: 2 },
      { title: 'Глава 1. Климат и история', page: 4 },
      { title: 'Глава 2. Эти таинственные шумеры', page: 36 },
      { title: 'Глава 3. Убейдцы и шумеры', page: 70 },
      { title: 'Глава 4. Конец периода Джемдет-Наср.', page: 109 },
      { title: 'Глава 5. Войны номов', page: 131 },
      { title: 'Глава 6. Расцвет и гибель Аккадского царства', page: 149 },
      { title: 'Глава 7. Возвышение Ура и появление амореев', page: 165 },
      { title: 'Глава 8. Ближний Восток в ХVI-ХIV веках до н. э.', page: 192 },
      { title: 'Глава 9. Коллапс бронзового века', page: 217 },
      { title: 'Глава 10. Современные изменения климата', page: 253 }
    ];

    // Build TOC
    tocEntries.forEach(ent => {
      const b = document.createElement('button');
      b.textContent = ent.title;
      b.addEventListener('click', () => { pageNum = ent.page; savePos(); render(); closeDrawer(); });
      tocList.appendChild(b);
    });

    function savePos() {
      localStorage.setItem('mPage', String(pageNum));
      localStorage.setItem('mScale', String(scale));
      localStorage.setItem('mFitWidth', JSON.stringify(fitWidth));
    }

    function openDrawer() { drawer.classList.add('open'); }
    function closeDrawer() { drawer.classList.remove('open'); }
    function toggleChrome() {
      showChrome = !showChrome;
      document.body.classList.toggle('chrome-visible', showChrome);
    }

    function updateMeta() {
      pageMeta.textContent = `Стр. ${pageNum} / ${totalPages}`;
      const p = totalPages ? Math.max(0, Math.min(100, Math.round(pageNum / totalPages * 100))) : 0;
      progressBar.style.width = p + '%';
    }

    // Core render (DPR-aware)
    let originalPageWidth = null;
    pdfjsLib.getDocument(PDF_URL).promise.then(pdf => {
      pdfDoc = pdf; totalPages = pdf.numPages;
      const storedPage = parseInt(localStorage.getItem('mPage') || '1', 10);
      if (!isNaN(storedPage) && storedPage >= 1 && storedPage <= totalPages) pageNum = storedPage;
      render();
    }).catch(err => console.error('PDF load error:', err));

    function render() {
      if (!pdfDoc) return;
      pdfDoc.getPage(pageNum).then(page => {
        const dpr = window.devicePixelRatio || 1;
        if (!originalPageWidth) {
          originalPageWidth = page.getViewport({ scale: 1 }).width;
        }
        // Calculate scale
        let s = scale;
        if (fitWidth) {
          const target = Math.min(window.innerWidth, document.documentElement.clientWidth);
          s = target / originalPageWidth;
        }
        const viewport = page.getViewport({ scale: s });
        const outW = Math.floor(viewport.width * dpr);
        const outH = Math.floor(viewport.height * dpr);
        canvas.width = outW; canvas.height = outH;
        canvas.style.width = Math.floor(viewport.width) + 'px';
        canvas.style.height = Math.floor(viewport.height) + 'px';

        const rc = { canvasContext: ctx, viewport, transform: dpr !== 1 ? [dpr,0,0,dpr,0,0] : null };
        page.render(rc).promise.then(() => {
          updateMeta();
          setScrollMode(shouldScroll() || isLandscape());
        });
      });
    }

    // Simple gestures
    zonePrev.addEventListener('click', () => { if (pageNum > 1) { pageNum--; savePos(); render(); } });
    zoneNext.addEventListener('click', () => { if (pageNum < totalPages) { pageNum++; savePos(); render(); } });
    zoneToggle.addEventListener('click', toggleChrome);

    // Swipe
    let startX = 0, startY = 0, active = false;
    window.addEventListener('touchstart', (e) => {
      if (e.touches.length !== 1) return;
      active = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY;
    }, {passive:true});
    window.addEventListener('touchend', (e) => {
      if (!active) return; active = false;
      const dx = (e.changedTouches[0].clientX - startX);
      const dy = (e.changedTouches[0].clientY - startY);
      const preferVertical = Math.abs(dy) > Math.abs(dx) && document.body.classList.contains('scrollY');
      if (!preferVertical && Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) {
        if (dx < 0 && pageNum < totalPages) { pageNum++; savePos(); render(); }
        if (dx > 0 && pageNum > 1) { pageNum--; savePos(); render(); }
      } else {
        toggleChrome();
      }
    }, {passive:true});

    // Zoom controls
    function setScaleFromSlider(v) {
      fitWidth = false;
      scale = Math.max(0.5, Math.min(3.0, v / 100));
      savePos(); render();
    }
    zoomSlider.addEventListener('input', (e) => setScaleFromSlider(parseInt(e.target.value,10)));
    zoomInBtn.addEventListener('click', () => { zoomSlider.value = Math.min(220, parseInt(zoomSlider.value,10) + 10); setScaleFromSlider(parseInt(zoomSlider.value,10)); });
    zoomOutBtn.addEventListener('click', () => { zoomSlider.value = Math.max(70, parseInt(zoomSlider.value,10) - 10); setScaleFromSlider(parseInt(zoomSlider.value,10)); });
    fitBtn.addEventListener('click', () => { fitWidth = true; savePos(); render(); });

    // Topbar buttons
    menuBtn.addEventListener('click', () => { drawer.classList.toggle('open'); });
    aaBtn.addEventListener('click', () => { toggleChrome(); }); // acts as quick chrome toggle

    // Orientation / resize reflow
    window.addEventListener('resize', () => { render(); });

    // Close drawer on outside swipe from left
    let drawerStartX = null;
    drawer.addEventListener('touchstart', (e) => { if (e.touches.length===1) drawerStartX = e.touches[0].clientX; }, {passive:true});
    drawer.addEventListener('touchend', (e) => {
      if (drawerStartX==null) return;
      const dx = e.changedTouches[0].clientX - drawerStartX;
      if (dx > 70) closeDrawer();
      drawerStartX = null;
    }, {passive:true});
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Комментарии к книге «От каменного века до века железа»</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --font-base: 18px; --page-w: 1100px; --card-pad: 14px; }
    body { font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; font-size: var(--font-base); line-height: 1.7; max-width: var(--page-w); margin: 12px auto; padding: 12px; background: #f9f9f9; color: #222; }
    h1 { text-align: center; margin: 0 0 14px; font-size: calc(var(--font-base)*1.7); line-height: 1.25; letter-spacing: .2px; }
    .muted { opacity: .85; }
    .card { background:#fff; padding:var(--card-pad); border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .layout { display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; align-items:start; }

    label { display:block; margin:.65rem 0 .35rem; font-size:calc(var(--font-base)*.95); }
    input, textarea, button { font:inherit; font-size:1rem; box-sizing:border-box; }
    input, textarea { width:100%; border:1px solid #cfcfcf; border-radius:10px; padding:12px; background:#fff; }
    textarea { min-height:160px; font-size: 20px; line-height:1.6; }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .row > * { flex:1 1 240px; }

    button, .btn { display:inline-block; border:1px solid #111; border-radius:999px; padding:12px 18px; background:#111; color:#fff; cursor:pointer; text-decoration:none; }
    button:hover, .btn:hover { filter:brightness(1.06); }

    .hint { background:#fafafa; border:1px dashed #ccc; border-radius:10px; padding:12px; margin-top:12px; }
    .sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0; }

    /* Fade animation */
    #commentForm { transition: opacity 0.6s ease, height 0.6s ease; }
    #commentForm.hidden { opacity:0; pointer-events:none; height:0; overflow:hidden; }
    .success { display:none; opacity:0; margin-top:14px; padding:14px; background:#ebffe9; border:1px solid #96d190; border-radius:12px; transition: opacity 0.6s ease; }
    .success.show { display:block; opacity:1; }
    .success h3 { margin:0 0 8px; font-size: calc(var(--font-base)*1.05); }
    .success .actions { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }

    @media (max-width:920px){
      .layout { grid-template-columns:1fr; }
      h1 { font-size: calc(var(--font-base)*1.55); }
      input, textarea { padding:14px; }
    }
  </style>
</head>
<body>

  <h1>Комментарии к книге «От каменного века до века железа»</h1>

  <div class="layout">
    <!-- Левая колонка: форма + локальный "спасибо" -->
    <div class="card">
      <p class="muted" style="margin-top:0">
        Отправьте комментарий. Мы просматриваем все сообщения и публикуем одобренные.
      </p>

      <!-- ✅ FIXED: правильный endpoint -->
      <form id="commentForm" action="https://formspree.io/f/manbrpkr" method="POST">
        <input type="hidden" name="_replyto" value="kalimanbooks@gmail.com">
        <input type="hidden" name="_subject" value="Новый комментарий к книге">
        <input type="hidden" name="file" value="От каменного века до века железа">

        <div class="row">
          <div>
            <label for="from">От кого (необязательно)</label>
            <input id="from" name="user_name" maxlength="60" placeholder="Например: «Анна, Сан-Диего»">
          </div>
          <div>
            <label for="page">Номер страницы (необязательно)</label>
            <input id="page" name="page" inputmode="numeric" pattern="[0-9]*" placeholder="например: 12">
          </div>
        </div>

        <div>
          <label for="topic">Тема (необязательно, для приватного сообщения добавьте #private)</label>
          <input id="topic" name="topic" maxlength="80" placeholder="Напр.: Вопрос по иллюстрациям">
        </div>

        <label for="message">Ваш комментарий</label>
        <textarea id="message" name="message" required maxlength="5000"
          placeholder="Коротко и по делу (до 5000 символов)"></textarea>

        <!-- honeypot -->
        <label class="sr-only" for="_gotcha">Оставьте это поле пустым</label>
        <input id="_gotcha" type="text" name="_gotcha" style="display:none" autocomplete="off" tabindex="-1" aria-hidden="true">

        <div class="hint">
          Подсказки: укажите страницу/раздел; максимум одна релевантная ссылка; без личных данных.
        </div>

        <p style="margin-top:16px">
          <button id="submitBtn" type="submit">Отправить комментарий</button>
        </p>
      </form>

      <div id="successBox" class="success" role="status" aria-live="polite">
        <h3>Спасибо! Ваш комментарий отправлен.</h3>
        <p class="muted" style="margin:0">Мы получили сообщение. После проверки можем опубликовать его на сайте.</p>
        <div class="actions">
          <a class="btn" href="/kaliman-books/">На главную</a>
          <button class="btn" id="anotherBtn" type="button">Оставить ещё один комментарий</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:.2rem 0 .6rem;font-size:calc(var(--font-base)*1.05);color:#222;text-align:center">Правила</h2>
      <ul class="rules-list muted" style="margin:.3rem 0 0; padding-left:1.1rem;">
        <li>По теме и уважительно; без оскорблений и разглашения личных данных.</li>
        <li>Без рекламы; ссылки — по усмотрению модератора.</li>
        <li>Максимум 5000 символов; возможна лёгкая правка для ясности.</li>
        <li>Поле «От кого» — необязательное. Можно оставить анонимно.</li>
        <li>Чтобы не публиковать сообщение, добавьте <code>#private</code> в «Тему».</li>
        <li>Отправляя сообщение, вы соглашаетесь <strong>на модерацию в случае его публикации.</strong></li>
      </ul>
    </div>
  </div>

  <script>
    const form = document.getElementById('commentForm');
    const successBox = document.getElementById('successBox');
    const anotherBtn = document.getElementById('anotherBtn');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.setAttribute('aria-busy', 'true');

      const data = new FormData(form);
      try {
        const res = await fetch(form.action, {
          method: form.method,
          body: data,
          headers: { 'Accept': 'application/json' }
        });

        if (res.ok) {
          form.reset();
          form.classList.add('hidden');
          successBox.classList.add('show');
          successBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          let msg = `Ошибка ${res.status}`;
          try {
            const j = await res.json();
            if (j && j.errors && j.errors.length) {
              msg += ': ' + j.errors.map(e => e.message).join('; ');
            }
          } catch (_) {}
          alert(msg);
        }
      } catch (err) {
        alert('Сеть недоступна. Попробуйте позже.');
      } finally {
        if (!successBox.classList.contains('show')) {
          submitBtn.disabled = false;
          submitBtn.removeAttribute('aria-busy');
        }
      }
    });

    anotherBtn.addEventListener('click', () => {
      successBox.classList.remove('show');
      form.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.removeAttribute('aria-busy');
      document.getElementById('from').focus();
    });
  </script>
</body>
</html>
